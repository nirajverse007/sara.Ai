<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sara AI - Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        html, body { height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; }
        .dark body { background-color: #0f172a; color: #f8fafc; }
        .glass { backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(30, 41, 59, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .loader { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-300">

    <div id="loading" class="fixed inset-0 z-[100] flex items-center justify-center bg-white dark:bg-slate-900">
        <div class="loader"></div>
    </div>

    <div id="app" class="flex h-[100dvh] w-full hidden">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 transform -translate-x-full md:relative md:translate-x-0 bg-white dark:bg-slate-900 border-r dark:border-slate-800 transition-transform duration-300 flex flex-col">
            <div class="p-4 border-b dark:border-slate-800 flex items-center gap-2">
                <button onclick="app.createNewChat()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl font-bold transition-all active:scale-95 shadow-lg shadow-blue-200 dark:shadow-none">
                    <i class="fas fa-plus mr-2"></i> New Chat
                </button>
            </div>
            
            <div id="chat-history-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>

            <div class="p-4 border-t dark:border-slate-800 space-y-1">
                <button onclick="app.toggleDarkMode()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                    <i id="dark-icon" class="fas fa-moon"></i> Appearance
                </button>
                <button onclick="app.openSettings()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button onclick="app.toggleVoice()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                    <i id="voice-icon" class="fas fa-volume-up text-blue-500"></i> Voice: <span id="voice-status">ON</span>
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/40 z-30 hidden md:hidden backdrop-blur-sm"></div>

        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-slate-950 relative">
            <header class="p-4 flex justify-between items-center glass sticky top-0 z-20">
                <button onclick="app.toggleSidebar()" class="md:hidden p-2 dark:text-white"><i class="fas fa-bars text-xl"></i></button>
                <div class="flex flex-col items-center">
                    <span id="mode-badge" class="text-[10px] font-bold px-3 py-0.5 bg-green-100 text-green-700 rounded-full dark:bg-green-900/30 dark:text-green-400 tracking-widest uppercase mb-0.5 transition-all">Standard</span>
                    <h1 class="font-bold text-gray-800 dark:text-white">Sara AI</h1>
                </div>
                <div class="w-8"></div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 pb-32"></div>

            <div class="absolute bottom-0 w-full p-4 md:p-6 bg-gradient-to-t from-white dark:from-slate-950 via-white dark:via-slate-950 to-transparent">
                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-gray-100 dark:bg-slate-900 p-2 rounded-2xl border dark:border-slate-800">
                    <textarea id="user-input" rows="1" placeholder="Poochiye Niraj Sir..." class="w-full bg-transparent p-3 border-none focus:ring-0 resize-none dark:text-white" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    <button onclick="app.sendMessage()" id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-lg transition-all active:scale-90"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-[2rem] w-full max-w-md p-8 shadow-2xl">
            <h2 class="text-2xl font-black mb-6 dark:text-white">Settings</h2>
            <div class="space-y-4">
                <input type="password" id="set-key" class="w-full p-4 bg-gray-100 dark:bg-slate-800 rounded-2xl border-none dark:text-white" placeholder="API Key">
                <input type="text" id="set-model" class="w-full p-4 bg-gray-100 dark:bg-slate-800 rounded-2xl border-none dark:text-white" placeholder="Model Name">
                <textarea id="set-helper" rows="2" class="w-full p-4 bg-gray-100 dark:bg-slate-800 rounded-2xl border-none dark:text-white" placeholder="Standard Prompt"></textarea>
                <textarea id="set-partner" rows="2" class="w-full p-4 bg-gray-100 dark:bg-slate-800 rounded-2xl border-none dark:text-white" placeholder="Partner Prompt"></textarea>
            </div>
            <button onclick="app.saveSettings()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold mt-8 shadow-lg active:scale-95">Save Changes</button>
        </div>
    </div>

    <script>
        const app = (() => {
            const PWD = "SARA-ADMIN-ACCESS-786";
            const els = {
                loading: document.getElementById('loading'), app: document.getElementById('app'),
                sidebar: document.getElementById('sidebar'), overlay: document.getElementById('sidebar-overlay'),
                chatList: document.getElementById('chat-history-list'), messagesContainer: document.getElementById('messages-container'),
                input: document.getElementById('user-input'), modeBadge: document.getElementById('mode-badge'),
                settings: { key: document.getElementById('set-key'), model: document.getElementById('set-model'), helper: document.getElementById('set-helper'), partner: document.getElementById('set-partner') }
            };

            let state = {
                chats: [], currentChatId: null,
                settings: { apiKey: '', model: 'google/gemini-2.0-flash-lite-preview-02-05:free', helperPrompt: 'You are Sara, helpful AI.', partnerPrompt: 'You are Sara, Niraj\'s partner.' },
                isAuthenticated: false, isVoiceEnabled: true, isDarkMode: false
            };

            function speak(text) {
                if (!state.isVoiceEnabled) return;
                window.speechSynthesis.cancel();
                const chunks = text.replace(/[*#_`]/g, '').split(/[.!?।\n]/).filter(s => s.trim().length > 0);
                chunks.forEach(chunk => {
                    const u = new SpeechSynthesisUtterance(chunk);
                    u.voice = window.speechSynthesis.getVoices().find(v => v.lang.includes('hi') || v.name.includes('Google'));
                    u.rate = 0.82; u.pitch = 1.1;
                    window.speechSynthesis.speak(u);
                });
            }

            function init() {
                const saved = localStorage.getItem('sara_v4_state');
                if (saved) {
                    const p = JSON.parse(saved);
                    state = {...state, ...p};
                    if(state.isDarkMode) document.documentElement.classList.add('dark');
                }
                els.loading.classList.add('hidden');
                els.app.classList.remove('hidden');
                renderChatList();
                if(state.chats.length > 0) selectChat(state.chats[0].id);
                else createNewChat();
            }

            async function sendMessage() {
                const text = els.input.value.trim();
                if (!text) return;
                if (text === PWD) {
                    state.isAuthenticated = true;
                    els.modeBadge.innerText = "Partner Mode ❤️";
                    els.modeBadge.className = "text-[10px] font-bold px-3 py-0.5 bg-pink-100 text-pink-700 rounded-full uppercase tracking-widest";
                    els.input.value = ''; speak("Activated!"); return;
                }
                const chat = state.chats.find(c => c.id === state.currentChatId);
                if(chat.messages.length === 0) chat.title = text.substring(0, 20);
                chat.messages.push({ role: 'user', content: text });
                els.input.value = ''; els.input.style.height = 'auto';
                renderMessages();
                const aiMsg = { role: 'assistant', content: '...' };
                chat.messages.push(aiMsg);
                renderMessages();
                try {
                    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${state.settings.apiKey}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ model: state.settings.model, messages: [{ role: "system", content: state.isAuthenticated ? state.settings.partnerPrompt : state.settings.helperPrompt }, ...chat.messages.filter(m => m.content !== '...')] })
                    });
                    const data = await res.json();
                    const reply = data.choices[0].message.content;
                    aiMsg.content = reply;
                    renderMessages(); speak(reply); saveState(); renderChatList();
                } catch (e) { aiMsg.content = "Error: " + e.message; renderMessages(); }
            }

            function renderChatList() {
                els.chatList.innerHTML = '';
                state.chats.forEach(c => {
                    const active = c.id === state.currentChatId;
                    const d = document.createElement('div');
                    d.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${active ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-gray-100 dark:hover:bg-slate-800 dark:text-slate-400'}`;
                    d.innerHTML = `
                        <div onclick="app.selectChat('${c.id}')" class="truncate text-sm flex-1"><i class="far fa-comment-dots mr-2"></i> ${c.title}</div>
                        <div class="hidden group-hover:flex gap-2">
                            <i onclick="app.renameChat('${c.id}')" class="fas fa-edit text-[10px] opacity-70 hover:opacity-100"></i>
                            <i onclick="app.deleteChat('${c.id}')" class="fas fa-trash text-[10px] opacity-70 hover:opacity-100"></i>
                        </div>`;
                    els.chatList.appendChild(d);
                });
            }

            function saveState() { localStorage.setItem('sara_v4_state', JSON.stringify({ settings: state.settings, chats: state.chats, isDarkMode: state.isDarkMode })); }

            return {
                init, sendMessage, createNewChat: () => {
                    const id = 'c' + Date.now();
                    state.chats.unshift({ id, title: 'New Conversation', messages: [] });
                    state.currentChatId = id; state.isAuthenticated = false; renderChatList(); renderMessages();
                },
                selectChat: (id) => { state.currentChatId = id; renderChatList(); renderMessages(); },
                deleteChat: (id) => { state.chats = state.chats.filter(c => c.id !== id); if(state.currentChatId === id) state.currentChatId = state.chats[0]?.id; saveState(); renderChatList(); renderMessages(); },
                renameChat: (id) => { const n = prompt("New Name?"); if(n) { state.chats.find(c => c.id === id).title = n; saveState(); renderChatList(); } },
                toggleDarkMode: () => { state.isDarkMode = !state.isDarkMode; document.documentElement.classList.toggle('dark'); saveState(); },
                toggleSidebar: () => { els.sidebar.classList.toggle('-translate-x-full'); els.overlay.classList.toggle('hidden'); },
                openSettings: () => { els.settings.key.value = state.settings.apiKey; els.settings.model.value = state.settings.model; els.settings.helper.value = state.settings.helperPrompt; els.settings.partner.value = state.settings.partnerPrompt; document.getElementById('settings-modal').classList.remove('hidden'); },
                saveSettings: () => { state.settings.apiKey = els.settings.key.value; state.settings.model = els.settings.model.value; state.settings.helperPrompt = els.settings.helper.value; state.settings.partnerPrompt = els.settings.partner.value; saveState(); document.getElementById('settings-modal').classList.add('hidden'); },
                toggleVoice: () => { state.isVoiceEnabled = !state.isVoiceEnabled; document.getElementById('voice-status').innerText = state.isVoiceEnabled ? 'ON' : 'OFF'; }
            };
        })();
        window.onload = app.init;
    </script>
</body>
</html>
