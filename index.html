<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sara AI - Clean Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        html, body { height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; }
        .dark body { background-color: #0f172a; color: #f8fafc; }
        .glass { backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(30, 41, 59, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .message-appear { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .prose p { margin-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-300">

    <div id="loading" class="fixed inset-0 z-[100] flex items-center justify-center bg-white dark:bg-slate-900">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div id="app" class="flex h-[100dvh] w-full hidden">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 transform -translate-x-full md:relative md:translate-x-0 bg-white dark:bg-slate-900 border-r dark:border-slate-800 transition-transform duration-300 flex flex-col shadow-xl md:shadow-none">
            <div class="p-4 border-b dark:border-slate-800">
                <button onclick="app.createNewChat()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl font-bold transition-all shadow-lg active:scale-95">
                    <i class="fas fa-plus mr-2"></i> New Chat
                </button>
            </div>
            <div id="chat-history-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
            <div class="p-4 border-t dark:border-slate-800 space-y-2">
                <button onclick="app.toggleDarkMode()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-xl transition-colors dark:text-gray-300"><i id="dark-icon" class="fas fa-moon"></i> Appearance</button>
                <button onclick="app.openSettings()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-xl transition-colors dark:text-gray-300"><i class="fas fa-cog"></i> Settings</button>
                <button onclick="app.toggleVoice()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-xl transition-colors dark:text-gray-300"><i id="voice-icon" class="fas fa-volume-up text-blue-500"></i> Voice: <span id="voice-status">ON</span></button>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm"></div>

        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-slate-950 relative">
            <header class="p-4 flex justify-between items-center glass sticky top-0 z-20">
                <button onclick="app.toggleSidebar()" class="md:hidden p-2 dark:text-white"><i class="fas fa-bars text-xl"></i></button>
                <div class="flex flex-col items-center">
                    <span id="mode-badge" class="text-[10px] font-bold px-3 py-0.5 bg-gray-200 text-gray-600 rounded-full dark:bg-slate-800 dark:text-gray-300 tracking-widest uppercase mb-0.5">Assistant Mode</span>
                    <h1 class="font-bold text-gray-800 dark:text-white">Sara AI</h1>
                </div>
                <div class="w-8"></div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 pb-32"></div>

            <div class="absolute bottom-0 w-full p-4 md:p-6 bg-gradient-to-t from-white dark:from-slate-950 via-white dark:via-slate-950 to-transparent">
                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-gray-100 dark:bg-slate-900 p-2 rounded-2xl border dark:border-slate-800 shadow-sm">
                    <textarea id="user-input" rows="1" placeholder="Type here..." class="w-full bg-transparent p-3 border-none focus:ring-0 resize-none dark:text-white max-h-32 overflow-y-auto" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    <button onclick="app.sendMessage()" id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-lg transition-all active:scale-90"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl w-full max-w-md p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-bold mb-4 dark:text-white">Settings</h2>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-gray-500 uppercase">API Key</label><input type="password" id="set-key" class="w-full p-3 bg-gray-100 dark:bg-slate-800 rounded-xl border-none dark:text-white mt-1"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Model</label><input type="text" id="set-model" class="w-full p-3 bg-gray-100 dark:bg-slate-800 rounded-xl border-none dark:text-white mt-1"></div>
                <div><label class="text-xs font-bold text-blue-600 uppercase">Standard Mode (Public)</label><textarea id="set-helper" rows="3" class="w-full p-3 bg-blue-50 dark:bg-slate-800 rounded-xl border-none dark:text-white mt-1 text-sm" placeholder="Prompt for Assistant mode..."></textarea></div>
                <div><label class="text-xs font-bold text-pink-600 uppercase">Partner Mode (Private)</label><textarea id="set-partner" rows="3" class="w-full p-3 bg-pink-50 dark:bg-slate-800 rounded-xl border-none dark:text-white mt-1 text-sm" placeholder="Prompt for Girlfriend mode..."></textarea></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="app.closeSettings()" class="px-4 py-2 text-gray-500">Cancel</button>
                <button onclick="app.saveSettings()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">Save</button>
            </div>
        </div>
    </div>

    <script>
        const app = (() => {
            const PWD = "SARA-ADMIN-ACCESS-786";
            
            const els = {
                loading: document.getElementById('loading'), app: document.getElementById('app'),
                sidebar: document.getElementById('sidebar'), overlay: document.getElementById('sidebar-overlay'),
                chatList: document.getElementById('chat-history-list'), messagesContainer: document.getElementById('messages-container'),
                input: document.getElementById('user-input'), modeBadge: document.getElementById('mode-badge'),
                settings: { key: document.getElementById('set-key'), model: document.getElementById('set-model'), helper: document.getElementById('set-helper'), partner: document.getElementById('set-partner') }
            };

            let state = {
                chats: [], currentChatId: null,
                settings: { apiKey: '', model: 'google/gemini-2.0-flash-lite-preview-02-05:free', helperPrompt: '', partnerPrompt: '' }, // Blank Defaults
                isAuthenticated: false, isVoiceEnabled: true, isDarkMode: false
            };

            function speak(text) {
                if (!state.isVoiceEnabled) return;
                window.speechSynthesis.cancel();
                const chunks = text.replace(/[*#_`]/g, '').split(/[.!?।\n]/).filter(s => s.trim().length > 0);
                chunks.forEach(chunk => {
                    const u = new SpeechSynthesisUtterance(chunk);
                    const voices = window.speechSynthesis.getVoices();
                    u.voice = voices.find(v => v.lang.includes('hi') || v.name.includes('Google') || v.name.includes('Natural')) || voices[0];
                    u.rate = 0.85; u.pitch = 1.1; 
                    window.speechSynthesis.speak(u);
                });
            }

            function init() {
                const saved = localStorage.getItem('sara_clean_state');
                if (saved) {
                    const p = JSON.parse(saved);
                    state.settings = { ...state.settings, ...p.settings };
                    state.chats = p.chats || [];
                    state.isDarkMode = p.isDarkMode || false;
                }
                if(state.isDarkMode) document.documentElement.classList.add('dark');
                els.loading.classList.add('hidden');
                els.app.classList.remove('hidden');
                els.input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); app.sendMessage(); } });
                renderChatList();
                if(state.chats.length > 0) selectChat(state.chats[0].id);
                else createNewChat();
            }

            async function sendMessage() {
                const text = els.input.value.trim();
                if (!text) return;

                if (text === PWD) {
                    state.isAuthenticated = true;
                    updateModeUI(true);
                    els.input.value = '';
                    const msg = "Partner Mode Activated ❤️";
                    speak(msg); alert(msg); return;
                }

                if (!state.currentChatId) createNewChat();
                const chat = state.chats.find(c => c.id === state.currentChatId);
                if(chat.messages.length === 0) chat.title = text.substring(0, 20) + "...";
                
                chat.messages.push({ role: 'user', content: text });
                els.input.value = ''; els.input.style.height = 'auto';
                renderMessages();

                const aiMsg = { role: 'assistant', content: '...', id: Date.now() };
                chat.messages.push(aiMsg);
                renderMessages();

                // Logic: Select Prompt based on Password (Authentication)
                const systemInstruction = state.isAuthenticated ? state.settings.partnerPrompt : state.settings.helperPrompt;

                try {
                    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${state.settings.apiKey}`, "Content-Type": "application/json", "HTTP-Referer": "http://localhost" },
                        body: JSON.stringify({
                            model: state.settings.model,
                            messages: [
                                { role: "system", content: systemInstruction },
                                ...chat.messages.filter(m => m.content !== '...' && m.id !== aiMsg.id)
                            ]
                        })
                    });
                    
                    if(!res.ok) throw new Error("API Error");
                    const data = await res.json();
                    const reply = data.choices[0].message.content;
                    aiMsg.content = reply; renderMessages(); speak(reply); saveState(); renderChatList();
                } catch (e) { aiMsg.content = "Error: " + e.message; renderMessages(); }
            }

            function updateModeUI(isPartner) {
                if(isPartner) {
                    els.modeBadge.innerText = "Partner Mode ❤️";
                    els.modeBadge.className = "text-[10px] font-bold px-3 py-0.5 bg-pink-100 text-pink-700 rounded-full dark:bg-pink-900 dark:text-pink-300 tracking-widest uppercase mb-0.5";
                } else {
                    els.modeBadge.innerText = "Standard Mode";
                    els.modeBadge.className = "text-[10px] font-bold px-3 py-0.5 bg-gray-200 text-gray-600 rounded-full dark:bg-slate-800 dark:text-gray-300 tracking-widest uppercase mb-0.5";
                }
            }

            function createNewChat() {
                const id = 'c' + Date.now();
                state.chats.unshift({ id, title: 'New Conversation', messages: [] });
                state.currentChatId = id;
                state.isAuthenticated = false; updateModeUI(false);
                renderChatList(); renderMessages();
                if(window.innerWidth < 768) els.sidebar.classList.add('-translate-x-full');
            }

            function selectChat(id) { 
                state.currentChatId = id; renderChatList(); renderMessages();
                if(window.innerWidth < 768) els.sidebar.classList.add('-translate-x-full'); 
            }

            function renderChatList() {
                els.chatList.innerHTML = '';
                state.chats.forEach(c => {
                    const active = c.id === state.currentChatId;
                    const d = document.createElement('div');
                    d.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${active ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-gray-100 dark:hover:bg-slate-800 dark:text-slate-400'}`;
                    d.innerHTML = `
                        <div onclick="app.selectChat('${c.id}')" class="truncate text-sm flex-1 font-medium">${c.title}</div>
                        <div class="hidden group-hover:flex gap-2">
                            <button onclick="event.stopPropagation(); app.renameChat('${c.id}')" class="text-xs opacity-70 hover:opacity-100"><i class="fas fa-edit"></i></button>
                            <button onclick="event.stopPropagation(); app.deleteChat('${c.id}')" class="text-xs opacity-70 hover:opacity-100"><i class="fas fa-trash"></i></button>
                        </div>`;
                    els.chatList.appendChild(d);
                });
            }

            function renderMessages() {
                const chat = state.chats.find(c => c.id === state.currentChatId);
                els.messagesContainer.innerHTML = '';
                if (!chat) return;
                chat.messages.forEach(m => {
                    const isUser = m.role === 'user';
                    const d = document.createElement('div');
                    d.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-appear`;
                    d.innerHTML = `<div class="max-w-[85%] p-3 md:p-4 rounded-2xl ${isUser ? 'bg-blue-600 text-white shadow-md rounded-br-none' : 'bg-white dark:bg-slate-800 dark:text-gray-200 shadow-sm border dark:border-slate-700 rounded-bl-none'} prose text-sm md:text-base">${marked.parse(m.content)}</div>`;
                    els.messagesContainer.appendChild(d);
                });
                els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight;
            }

            function saveState() { localStorage.setItem('sara_clean_state', JSON.stringify({ settings: state.settings, chats: state.chats, isDarkMode: state.isDarkMode })); }

            return {
                init, sendMessage, createNewChat, selectChat,
                deleteChat: (id) => { if(confirm("Delete this chat?")) { state.chats = state.chats.filter(c => c.id !== id); if(state.currentChatId === id) createNewChat(); else { saveState(); renderChatList(); } } },
                renameChat: (id) => { const n = prompt("Rename:"); if(n) { state.chats.find(c => c.id === id).title = n; saveState(); renderChatList(); } },
                toggleDarkMode: () => { state.isDarkMode = !state.isDarkMode; document.documentElement.classList.toggle('dark'); saveState(); },
                toggleSidebar: () => { els.sidebar.classList.toggle('-translate-x-full'); els.overlay.classList.toggle('hidden'); },
                openSettings: () => { els.settings.key.value = state.settings.apiKey; els.settings.model.value = state.settings.model; els.settings.helper.value = state.settings.helperPrompt; els.settings.partner.value = state.settings.partnerPrompt; document.getElementById('settings-modal').classList.remove('hidden'); },
                closeSettings: () => document.getElementById('settings-modal').classList.add('hidden'),
                saveSettings: () => { state.settings.apiKey = els.settings.key.value; state.settings.model = els.settings.model.value; state.settings.helperPrompt = els.settings.helper.value; state.settings.partnerPrompt = els.settings.partner.value; saveState(); document.getElementById('settings-modal').classList.add('hidden'); },
                toggleVoice: () => { state.isVoiceEnabled = !state.isVoiceEnabled; document.getElementById('voice-status').innerText = state.isVoiceEnabled ? 'ON' : 'OFF'; if(!state.isVoiceEnabled) window.speechSynthesis.cancel(); }
            };
        })();
        window.onload = app.init;
    </script>
</body>
</html>
