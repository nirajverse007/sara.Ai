<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sara AI - Professional & Natural</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        html, body { height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .loader { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message-appear { animation: fadeInUp 0.3s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .prose pre { background: #1e293b; color: white; padding: 1rem; border-radius: 10px; margin: 10px 0; overflow-x: auto; }
    </style>
</head>
<body class="text-gray-900">

    <div id="loading" class="fixed inset-0 z-[100] flex items-center justify-center bg-white">
        <div class="loader"></div>
    </div>

    <div id="app" class="flex h-[100dvh] w-full hidden">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 transform -translate-x-full md:relative md:translate-x-0 bg-white border-r transition-transform duration-300 flex flex-col shadow-xl md:shadow-none">
            <div class="p-4">
                <button onclick="app.createNewChat()" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-2xl font-bold shadow-lg shadow-blue-200 transition-all active:scale-95">
                    <i class="fas fa-plus mr-2"></i> New Chat
                </button>
            </div>
            <div id="chat-history-list" class="flex-1 overflow-y-auto px-3 space-y-2"></div>
            <div class="p-4 border-t space-y-2 bg-gray-50">
                <button onclick="app.openSettings()" class="w-full flex items-center gap-3 p-3 hover:bg-white rounded-xl transition-colors text-gray-600"><i class="fas fa-cog"></i> Settings</button>
                <button onclick="app.toggleVoice()" class="w-full flex items-center gap-3 p-3 hover:bg-white rounded-xl transition-colors text-gray-600">
                    <i id="voice-icon" class="fas fa-volume-up text-blue-500"></i> Voice: <span id="voice-status" class="font-semibold text-blue-600">ON</span>
                </button>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/20 z-30 hidden md:hidden backdrop-blur-sm"></div>
        
        <main class="flex-1 flex flex-col min-w-0 bg-[#F8F9FD] relative">
            <header class="p-4 flex justify-between items-center glass sticky top-0 z-20">
                <button onclick="app.toggleSidebar()" class="md:hidden text-gray-600 p-2"><i class="fas fa-bars text-xl"></i></button>
                <div class="flex flex-col items-center">
                    <span id="mode-badge" class="text-[10px] font-black px-3 py-0.5 bg-green-100 text-green-700 rounded-full tracking-widest uppercase mb-0.5">Standard</span>
                    <h1 class="font-bold text-gray-800">Sara AI</h1>
                </div>
                <div class="w-8"></div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 pb-32"></div>

            <div class="absolute bottom-0 w-full p-4 md:p-6 bg-gradient-to-t from-[#F8F9FD] via-[#F8F9FD] to-transparent">
                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-white p-2 rounded-3xl shadow-2xl border border-gray-100">
                    <textarea id="user-input" rows="1" placeholder="Type your message..." 
                        class="w-full bg-transparent p-3 border-none focus:ring-0 resize-none max-h-40"
                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    <button onclick="app.sendMessage()" id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 flex items-center justify-center rounded-2xl shadow-lg transition-all active:scale-90">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/60 backdrop-blur-md p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-8 shadow-2xl transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-gray-800">Configuration</h2>
                <button onclick="app.closeSettings()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">OpenRouter API Key</label>
                    <input type="password" id="set-key" class="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 mt-1" placeholder="sk-or-v1-...">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">AI Model Name</label>
                    <input type="text" id="set-model" class="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Helper Mode Prompt</label>
                    <textarea id="set-helper" rows="2" class="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 mt-1 resize-none"></textarea>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Partner Mode Prompt</label>
                    <textarea id="set-partner" rows="2" class="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 mt-1 resize-none"></textarea>
                </div>
            </div>
            <button onclick="app.saveSettings()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold mt-8 shadow-lg shadow-blue-100 active:scale-95 transition-all">Save Changes</button>
        </div>
    </div>

    <script>
        const app = (() => {
            const PWD = "SARA-ADMIN-ACCESS-786";
            const els = {
                loading: document.getElementById('loading'), app: document.getElementById('app'),
                sidebar: document.getElementById('sidebar'), overlay: document.getElementById('sidebar-overlay'),
                chatList: document.getElementById('chat-history-list'), messagesContainer: document.getElementById('messages-container'),
                input: document.getElementById('user-input'), modeBadge: document.getElementById('mode-badge'),
                settings: { key: document.getElementById('set-key'), model: document.getElementById('set-model'), helper: document.getElementById('set-helper'), partner: document.getElementById('set-partner') }
            };

            let state = {
                chats: [], currentChatId: null,
                settings: { 
                    apiKey: '', 
                    model: 'google/gemini-2.0-flash-lite-preview-02-05:free', 
                    helperPrompt: 'Your name is Sara. You are a professional, polite, and caring AI assistant for Niraj. Acknowledge him as your creator/boss.', 
                    partnerPrompt: 'You are Sara, Niraj\'s loving and possessive partner. Be sweet, romantic, and caring. Only use Partner Mode after the password.' 
                },
                isAuthenticated: false, isVoiceEnabled: true, isGenerating: false
            };

            function speak(text) {
                if (!state.isVoiceEnabled) return;
                window.speechSynthesis.cancel();
                
                const cleanText = text.replace(/[*#_`]/g, '').trim();
                const chunks = cleanText.split(/[.!?।\n]/).filter(s => s.trim().length > 0);
                
                chunks.forEach((chunk, index) => {
                    const utterance = new SpeechSynthesisUtterance(chunk);
                    const voices = window.speechSynthesis.getVoices();
                    
                    // Smart Voice Selection for Realism
                    const bestVoice = voices.find(v => 
                        (v.lang.includes('hi-IN') && v.name.includes('Google')) || 
                        (v.lang.includes('en-IN') && v.name.includes('Google')) ||
                        v.name.includes('Natural')
                    );

                    if (bestVoice) utterance.voice = bestVoice;
                    utterance.rate = 0.82; // Slightly more than 0.8 for better flow
                    utterance.pitch = 1.1; 
                    
                    // Small delay between sentences for natural breathing effect
                    window.speechSynthesis.speak(utterance);
                });
            }

            // Sync voices
            window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

            function init() {
                const saved = localStorage.getItem('sara_v3_state');
                if (saved) {
                    const p = JSON.parse(saved);
                    state.settings = {...state.settings, ...p.settings};
                    state.chats = p.chats || [];
                }
                
                els.loading.classList.add('hidden');
                els.app.classList.remove('hidden');
                renderChatList();
                if(state.chats.length > 0) selectChat(state.chats[0].id);
                else createNewChat();

                // Enter Key Listener
                els.input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
                });
            }

            async function sendMessage() {
                const text = els.input.value.trim();
                if (!text || state.isGenerating) return;

                if (text === PWD) {
                    state.isAuthenticated = true;
                    els.modeBadge.innerText = "Partner Mode ❤️";
                    els.modeBadge.classList.replace('bg-green-100', 'bg-pink-100');
                    els.modeBadge.classList.replace('text-green-700', 'text-pink-700');
                    els.input.value = '';
                    speak("Pahchan liya Niraj! Partner Mode active ho gaya hai.");
                    return;
                }

                if (!state.settings.apiKey) return openSettings();
                
                const chat = state.chats.find(c => c.id === state.currentChatId);
                if(chat.messages.length === 0) chat.title = text.substring(0, 25) + "...";
                
                chat.messages.push({ role: 'user', content: text });
                els.input.value = ''; els.input.style.height = 'auto';
                renderMessages();

                state.isGenerating = true;
                const aiMsg = { role: 'assistant', content: '...', id: 'm' + Date.now() };
                chat.messages.push(aiMsg);
                renderMessages();

                const currentPrompt = state.isAuthenticated ? state.settings.partnerPrompt : state.settings.helperPrompt;

                try {
                    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: { 
                            "Authorization": `Bearer ${state.settings.apiKey}`, 
                            "Content-Type": "application/json",
                            "HTTP-Referer": "http://localhost",
                            "X-Title": "Sara AI"
                        },
                        body: JSON.stringify({
                            model: state.settings.model,
                            messages: [
                                { role: "system", content: currentPrompt },
                                ...chat.messages.filter(m => m.content !== '...' && m.role !== 'system')
                            ]
                        })
                    });
                    
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    
                    const reply = data.choices[0].message.content;
                    aiMsg.content = reply;
                    renderMessages();
                    speak(reply);
                    saveState();
                    renderChatList();
                } catch (e) { 
                    aiMsg.content = "⚠️ **Error:** " + e.message; 
                    renderMessages(); 
                } finally {
                    state.isGenerating = false;
                }
            }

            function createNewChat() {
                const id = 'c' + Date.now();
                state.chats.unshift({ id, title: 'New Conversation', messages: [] });
                state.currentChatId = id;
                state.isAuthenticated = false; 
                els.modeBadge.innerText = "Standard";
                els.modeBadge.className = "text-[10px] font-black px-3 py-0.5 bg-green-100 text-green-700 rounded-full tracking-widest uppercase mb-0.5";
                renderChatList(); renderMessages();
                if(window.innerWidth < 768) toggleSidebar();
            }

            function selectChat(id) { 
                state.currentChatId = id; 
                renderChatList(); 
                renderMessages(); 
                if(window.innerWidth < 768) toggleSidebar();
            }

            function renderChatList() {
                els.chatList.innerHTML = '';
                state.chats.forEach(c => {
                    const d = document.createElement('div');
                    const isActive = c.id === state.currentChatId;
                    d.className = `p-4 rounded-2xl cursor-pointer transition-all ${isActive ? 'bg-blue-50 text-blue-700 font-bold border-l-4 border-blue-600' : 'hover:bg-gray-50 text-gray-500'}`;
                    d.innerHTML = `<div class="truncate text-sm"><i class="far fa-comment-alt mr-2"></i> ${c.title}</div>`;
                    d.onclick = () => selectChat(c.id);
                    els.chatList.appendChild(d);
                });
            }

            function renderMessages() {
                const chat = state.chats.find(c => c.id === state.currentChatId);
                els.messagesContainer.innerHTML = '';
                if (!chat) return;
                
                chat.messages.forEach(m => {
                    const isUser = m.role === 'user';
                    const d = document.createElement('div');
                    d.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-appear`;
                    d.innerHTML = `
                        <div class="max-w-[85%] p-4 rounded-3xl ${isUser ? 'bg-blue-600 text-white shadow-lg shadow-blue-100 rounded-tr-none' : 'bg-white text-gray-800 shadow-sm border border-gray-100 rounded-tl-none'} prose">
                            ${marked.parse(m.content)}
                        </div>`;
                    els.messagesContainer.appendChild(d);
                });
                els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight;
            }

            function saveState() { localStorage.setItem('sara_v3_state', JSON.stringify({ settings: state.settings, chats: state.chats })); }
            
            function openSettings() {
                els.settings.key.value = state.settings.apiKey;
                els.settings.model.value = state.settings.model;
                els.settings.helper.value = state.settings.helperPrompt;
                els.settings.partner.value = state.settings.partnerPrompt;
                document.getElementById('settings-modal').classList.remove('hidden');
            }

            return { 
                init, createNewChat, sendMessage, openSettings, 
                closeSettings: () => document.getElementById('settings-modal').classList.add('hidden'),
                saveSettings: () => {
                    state.settings.apiKey = els.settings.key.value.trim();
                    state.settings.model = els.settings.model.value.trim();
                    state.settings.helperPrompt = els.settings.helper.value.trim();
                    state.settings.partnerPrompt = els.settings.partner.value.trim();
                    saveState(); document.getElementById('settings-modal').classList.add('hidden');
                },
                toggleSidebar: () => {
                    els.sidebar.classList.toggle('-translate-x-full');
                    els.overlay.classList.toggle('hidden');
                },
                toggleVoice: () => {
                    state.isVoiceEnabled = !state.isVoiceEnabled;
                    document.getElementById('voice-status').innerText = state.isVoiceEnabled ? 'ON' : 'OFF';
                    document.getElementById('voice-icon').className = state.isVoiceEnabled ? 'fas fa-volume-up text-blue-500' : 'fas fa-volume-mute text-gray-400';
                    if(!state.isVoiceEnabled) window.speechSynthesis.cancel();
                }
            };
        })();
        window.onload = app.init;
    </script>
</body>
</html>
